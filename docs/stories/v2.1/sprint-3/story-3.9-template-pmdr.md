# STORY 3.9: Template PMDR

**ID:** 3.9 | **Epic:** [EPIC-S3](../../../epics/epic-s3-quality-templates.md)
**Sprint:** 3 | **Points:** 3 | **Priority:** üü° Medium | **Created:** 2025-01-19
**Updated:** 2025-12-05
**Status:** ‚úÖ Done

**Reference:** [Decis√£o 9 - Template Engine](../../../audits/PEDRO-DECISION-LOG.md#decis√£o-9)

**Predecessor:** Story 3.6 (Template Engine Core) ‚úÖ

---

## User Story

**Como** PM (Morgan),
**Quero** template PMDR (Product Management Decision Record) em formato Handlebars,
**Para que** possa documentar decis√µes de produto de forma padronizada e rastre√°vel.

---

## Acceptance Criteria

### Template Structure
- [x] AC3.9.1: Template segue padr√£o similar ao ADR (Context, Decision, Impact)
- [x] AC3.9.2: Inclui se√ß√£o de Business Impact espec√≠fica para produto
- [x] AC3.9.3: Suporta stakeholders e approval workflow
- [x] AC3.9.4: Inclui m√©tricas de sucesso para a decis√£o

### Validation
- [x] AC3.9.5: JSON Schema valida output gerado
- [x] AC3.9.6: Valida que business impact n√£o est√° vazio

### Integration
- [x] AC3.9.7: Template registrado no TemplateEngine
- [x] AC3.9.8: Gera√ß√£o via CLI: `aios generate pmdr`

---

## Scope

### Template Location
`.aios-core/product/templates/pmdr.hbs`

### Template Structure

```handlebars
---
template_id: pmdr
template_name: Product Management Decision Record
version: 1.0
variables:
  - name: number
    type: number
    required: true
    auto: next_pmdr_number
  - name: title
    type: string
    required: true
    prompt: "T√≠tulo da decis√£o de produto:"
  - name: status
    type: choice
    required: true
    choices: [Draft, Under Review, Approved, Rejected, Superseded]
    default: Draft
  - name: owner
    type: string
    required: true
    prompt: "Quem √© o owner dessa decis√£o?"
  - name: stakeholders
    type: array
    required: true
    prompt: "Quem s√£o os stakeholders?"
  - name: context
    type: text
    required: true
    prompt: "Qual √© o contexto de produto/neg√≥cio?"
  - name: decision
    type: text
    required: true
    prompt: "Qual √© a decis√£o de produto tomada?"
  - name: businessImpact
    type: text
    required: true
    prompt: "Qual √© o impacto no neg√≥cio?"
  - name: successMetrics
    type: array
    required: true
---

# PMDR {{padNumber number 3}}: {{title}}

**Status:** {{status}}
**Date:** {{formatDate now "YYYY-MM-DD"}}
**Owner:** {{owner}}

---

## Stakeholders

{{#each stakeholders}}
- {{this}}
{{/each}}

---

## Context

### Business Context
{{context}}

### Current State
{{currentState}}

### Problem Statement
{{problemStatement}}

---

## Decision

{{decision}}

### Rationale
{{rationale}}

---

## Business Impact

### Expected Impact
{{businessImpact}}

### Revenue/Cost Implications
{{#if revenueImplications}}
- **Revenue:** {{revenueImplications}}
{{/if}}
{{#if costImplications}}
- **Cost:** {{costImplications}}
{{/if}}

### Customer Impact
{{customerImpact}}

---

## Success Metrics

| Metric | Current | Target | Timeline |
|--------|---------|--------|----------|
{{#each successMetrics}}
| {{this.metric}} | {{this.current}} | {{this.target}} | {{this.timeline}} |
{{/each}}

---

## Implementation

### Phases
{{#each implementationPhases}}
1. **{{this.name}}** ({{this.duration}}): {{this.description}}
{{/each}}

### Dependencies
{{#each dependencies}}
- {{this}}
{{/each}}

### Risks
| Risk | Impact | Mitigation |
|------|--------|------------|
{{#each risks}}
| {{this.risk}} | {{this.impact}} | {{this.mitigation}} |
{{/each}}

---

## Alternatives Considered

{{#if alternatives}}
{{#each alternatives}}
### Option {{add @index 1}}: {{this.name}}

{{this.description}}

**Why Not Chosen:** {{this.whyNot}}
{{/each}}
{{else}}
_No alternatives documented._
{{/if}}

---

## Approval

{{#if approvals}}
| Stakeholder | Decision | Date | Notes |
|-------------|----------|------|-------|
{{#each approvals}}
| {{this.stakeholder}} | {{this.decision}} | {{this.date}} | {{this.notes}} |
{{/each}}
{{else}}
_Pending approval._
{{/if}}

---

## Related Decisions

{{#if relatedPMDRs}}
{{#each relatedPMDRs}}
- [PMDR {{this.number}}](./pmdr-{{padNumber this.number 3}}.md): {{this.title}}
{{/each}}
{{else}}
_No related decisions._
{{/if}}

---

**Generated by:** AIOS Template Engine v2.0
**Template Version:** pmdr-1.0
```

### JSON Schema

`.aios-core/product/templates/engine/schemas/pmdr.schema.json`:

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "PMDR Template Variables",
  "type": "object",
  "required": ["number", "title", "status", "owner", "stakeholders", "context", "decision", "businessImpact", "successMetrics"],
  "properties": {
    "number": { "type": "integer", "minimum": 1 },
    "title": { "type": "string", "minLength": 5, "maxLength": 150 },
    "status": {
      "type": "string",
      "enum": ["Draft", "Under Review", "Approved", "Rejected", "Superseded"]
    },
    "owner": { "type": "string", "minLength": 1 },
    "stakeholders": {
      "type": "array",
      "minItems": 1,
      "items": { "type": "string" }
    },
    "context": { "type": "string", "minLength": 20 },
    "decision": { "type": "string", "minLength": 20 },
    "businessImpact": { "type": "string", "minLength": 20 },
    "successMetrics": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": ["metric", "target"],
        "properties": {
          "metric": { "type": "string" },
          "current": { "type": "string" },
          "target": { "type": "string" },
          "timeline": { "type": "string" }
        }
      }
    }
  }
}
```

---

## Tasks

### Design (2h)
- [x] 3.9.1: Design PMDR structure (similar to ADR)
  - [x] 3.9.1.1: Identify product-specific sections
  - [x] 3.9.1.2: Define approval workflow fields
  - [x] 3.9.1.3: Define success metrics structure

### Implementation (2h)
- [x] 3.9.2: Create Handlebars template
  - [x] 3.9.2.1: Base structure with business sections
  - [x] 3.9.2.2: Approval tracking table
  - [x] 3.9.2.3: Success metrics table
  - [x] 3.9.2.4: Register template in TemplateEngine (AC3.9.7)

### Integration (1h)
- [x] 3.9.3: Register CLI command
  - [x] 3.9.3.1: Add `pmdr` to supported types in TemplateEngine
  - [x] 3.9.3.2: Register CLI command `aios generate pmdr` (AC3.9.8)
  - [x] 3.9.3.3: Test CLI command execution

### Testing (2h)
- [x] 3.9.4: Test PMDR generation
  - [x] 3.9.4.1: Generate sample PMDR
  - [x] 3.9.4.2: Test approval workflow fields
  - [x] 3.9.4.3: Validate schema
  - [x] 3.9.4.4: Test CLI command `aios generate pmdr`

**Total Estimated:** 7h (~1 day)

---

## Dev Notes

### Reference Templates
- **ADR Template:** Reference [Story 3.8 - Template ADR](./story-3.8-template-adr.md) for pattern comparison
- **Template Engine:** Reference [Story 3.6 - Template Engine Core](./story-3.6-template-engine-core.md) for engine architecture

### Difference from ADR
- **ADR:** Technical/architecture decisions
- **PMDR:** Product/business decisions

Key differences:
- Business impact section (mandatory)
- Success metrics with targets
- Approval workflow tracking
- Revenue/cost implications

### Template Engine Integration
- Template auto-discovery: Place template at `.aios-core/product/templates/pmdr.hbs`
- Schema validation: Place schema at `.aios-core/product/templates/engine/schemas/pmdr.schema.json`
- Template registration: TemplateEngine automatically discovers templates in `.aios-core/product/templates/` directory
- CLI command: Register in CLI command handler (see Story 3.6 for CLI integration pattern)

### Testing

**Test File Location:** `.aios-core/product/templates/engine/__tests__/pmdr.test.js`

| Test ID | Name | Priority |
|---------|------|----------|
| PMDR-01 | Generate PMDR with required fields | P0 |
| PMDR-02 | Success metrics table renders | P0 |
| PMDR-03 | Approval workflow renders | P1 |
| PMDR-04 | Validation fails without businessImpact | P0 |
| PMDR-05 | CLI command `aios generate pmdr` executes successfully | P0 |

---

## ü§ñ CodeRabbit Integration

### Story Type Analysis

**Primary Type:** Tooling/Templates
**Secondary Type(s):** Documentation
**Complexity:** Low (template creation)

### Specialized Agent Assignment

**Primary Agents:**
- @dev: Template implementation

**Supporting Agents:**
- @pm: PMDR format review

### Quality Gate Tasks

- [ ] Pre-Commit (@dev): Run PMDR-01 to PMDR-05 tests
- [ ] Pre-PR (@github-devops): Validate template syntax and CLI command

### Self-Healing Configuration

**Expected Self-Healing:**
- Primary Agent: @dev (light mode)
- Max Iterations: 2
- Timeout: 10 minutes
- Severity Filter: CRITICAL only

**Predicted Behavior:**
- CRITICAL issues: Auto-fix
- HIGH issues: Document only

### Focus Areas

**Primary Focus:**
- Business impact validation
- Success metrics structure

**Secondary Focus:**
- Approval workflow correctness

---

## Dependencies

**Depends on:**
- Story 3.6 (Template Engine Core) ‚è≥

**Blocks:**
- Story 3.12 (Documentation Sprint 3)

---

## Definition of Done

- [x] All acceptance criteria met
- [x] Template generates valid PMDR
- [x] PMDR-01 to PMDR-05 tests pass
- [x] CLI command `aios generate pmdr` works correctly
- [x] QA Review passed
- [x] PR created and approved (PR #21 merged)

---

## Dev Agent Record

**Agent:** Dex (@dev) - Claude Opus 4.5
**Implementation Date:** 2025-12-05
**YOLO Mode:** Yes

### Files Created
| File | Purpose |
|------|---------|
| `.aios-core/cli/commands/generate/index.js` | CLI generate command implementation (AC3.9.8) |
| `tests/templates/pmdr.test.js` | PMDR test suite (PMDR-01 to PMDR-05 + extras) |

### Files Modified
| File | Changes |
|------|---------|
| `.aios-core/cli/index.js` | Added generate command registration |

### Pre-existing Files (No Changes Needed)
| File | Status |
|------|--------|
| `.aios-core/product/templates/pmdr.hbs` | Already complete with all required sections |
| `.aios-core/product/templates/engine/schemas/pmdr.schema.json` | Already complete with validation rules |
| `.aios-core/product/templates/engine/index.js` | 'pmdr' already in SUPPORTED_TYPES (AC3.9.7) |

### Test Results
- **Total Tests:** 13
- **Passed:** 13
- **Failed:** 0
- **Test Suites:** 1 passed

### Lint Results
- **Errors:** 0
- **Warnings:** 8 (console statements - expected for CLI)

### Completion Notes
- PMDR template and schema were already implemented, only CLI command and tests needed to be created
- CLI `aios generate pmdr` command now fully functional with options for title, number, status, owner
- CLI supports `aios generate list` and `aios generate info <type>` subcommands
- All 8 acceptance criteria verified and met

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-19 | 1.0 | Story created (in bundled file) | River |
| 2025-12-03 | 2.0 | Separated into individual story file | Pax (@po) |
| 2025-01-19 | 2.1 | PO validation completed; added missing tasks for AC3.9.7 and AC3.9.8; enhanced Dev Notes | Pax (@po) |
| 2025-12-05 | 2.2 | Story validated and approved; readiness score 8/10; predecessor 3.6 confirmed complete | Pax (@po) |
| 2025-12-05 | 2.3 | Implementation complete: CLI generate command created, tests passing (13/13), lint clean | Dex (@dev) |
| 2025-12-05 | 2.4 | QA Review PASS: All 8 ACs verified, 13/13 tests, gate file created | Quinn (@qa) |
| 2025-12-05 | 2.5 | PR #21 created and merged to main; Story marked as Done | Gage (@devops) |

---

## QA Results

### Review Date: 2025-12-05

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall:** Excellent

The implementation follows existing patterns well. The PMDR template and schema were already pre-existing and well-structured. The new CLI generate command follows Commander.js patterns used elsewhere in the codebase. Tests are comprehensive with 13 test cases covering all acceptance criteria.

### Refactoring Performed

None required. Code quality is good and follows existing patterns.

### Compliance Check

- Coding Standards: ‚úì (0 lint errors in new files)
- Project Structure: ‚úì (Files placed in correct locations)
- Testing Strategy: ‚úì (Unit tests with good coverage)
- All ACs Met: ‚úì (8/8 acceptance criteria verified)

### Improvements Checklist

All items passed review:

- [x] Template structure follows ADR pattern (AC3.9.1)
- [x] Business Impact section is mandatory (AC3.9.2)
- [x] Stakeholders and approval workflow supported (AC3.9.3)
- [x] Success metrics table renders correctly (AC3.9.4)
- [x] JSON Schema validation working (AC3.9.5)
- [x] Empty businessImpact validation enforced (AC3.9.6)
- [x] Template registered in TemplateEngine (AC3.9.7)
- [x] CLI command `aios generate pmdr` functional (AC3.9.8)

### Security Review

No security concerns. Template generation is read-only with no external data inputs. Schema validation prevents injection.

### Performance Considerations

No concerns. Template generation completes in <100ms. All 13 tests run in <1s.

### Files Modified During Review

None - no refactoring was needed.

### Gate Status

**Gate: PASS** ‚Üí `docs/qa/gates/3.9-template-pmdr.yml`

| Category | Status |
|----------|--------|
| Tests | 13/13 passing (100%) |
| Lint | 0 errors |
| Security | PASS |
| Performance | PASS |
| Reliability | PASS |
| Maintainability | PASS |

### Recommended Status

‚úì **Ready for Done** - All acceptance criteria met, tests passing, no issues found.

---

**Created by:** River üåä
**Validated by:** Pax üéØ (PO)
