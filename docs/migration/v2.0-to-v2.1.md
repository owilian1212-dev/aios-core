# Migration Guide: v2.0 to v2.1

> Step-by-step instructions for migrating from AIOS v2.0 flat structure to v2.1 modular architecture.

**Version:** 2.1.0
**Last Updated:** 2025-12-01
**Story:** [2.16 - Documentation Sprint 2](../stories/v2.1/sprint-2/story-2.16-documentation.md)

---

## Overview

AIOS v2.1 introduces a modular architecture that reorganizes the `.aios-core/` directory into four purpose-driven modules. This guide walks through the migration process.

### What's Changing

| Aspect | v2.0 | v2.1 |
|--------|------|------|
| **Structure** | Flat directories | 4 modules (core, development, product, infrastructure) |
| **File Count** | 200+ in root | Organized by module |
| **Loading** | All files loaded | Lazy loading by module |
| **Dependencies** | Implicit | Explicit module dependencies |

### Migration Path

```
v2.0 Flat Structure          v2.1 Modular Structure
├── agents/          ──►     development/agents/
├── tasks/           ──►     development/tasks/
├── workflows/       ──►     development/workflows/
├── templates/       ──►     product/templates/
├── checklists/      ──►     product/checklists/
├── scripts/         ──►     infrastructure/scripts/
├── config/          ──►     core/config/
├── elicitation/     ──►     core/elicitation/
└── data/            ──►     (distributed by purpose)
```

---

## Prerequisites

### Before You Begin

1. **Backup your project**
   ```bash
   # Create timestamped backup
   cp -r .aios-core .aios-core.backup.$(date +%Y%m%d)
   ```

2. **Check current version**
   ```bash
   # Verify you're on v2.0
   cat .aios-core/package.json | grep version
   ```

3. **Ensure clean git state**
   ```bash
   git status  # Should show no uncommitted changes
   ```

4. **Verify Node.js version**
   ```bash
   node --version  # Should be 18.0.0 or higher
   ```

---

## Step-by-Step Migration

### Step 1: Dry Run

Preview what will change without making modifications:

```bash
aios migrate --dry-run
```

**Expected Output:**
```
Migration Preview: v2.0 → v2.1
==============================

Files to move:
  agents/dev.md → development/agents/dev.md
  agents/qa.md → development/agents/qa.md
  [... 11 agent files]

  tasks/create-story.md → development/tasks/po-create-story.md
  [... 115+ task files]

  templates/story-tmpl.yaml → product/templates/story-tmpl.yaml
  [... 52+ template files]

Directories to create:
  core/
  development/
  product/
  infrastructure/

Summary:
  Files to move: 243
  Directories to create: 4
  Estimated time: ~30 seconds

Run 'aios migrate' to execute.
```

### Step 2: Create Backup

The migration tool automatically creates a backup, but you can also create one manually:

```bash
# Automatic backup (recommended)
aios migrate --backup

# Manual backup
tar -czf aios-core-v2.0-backup.tar.gz .aios-core/
```

**Backup Location:** `.aios-backups/v2.0-YYYYMMDD-HHMMSS/`

### Step 3: Execute Migration

Run the migration:

```bash
aios migrate --from=2.0 --to=2.1
```

**Expected Output:**
```
Starting migration: v2.0 → v2.1
================================

[1/5] Creating backup... ✓
  Backup: .aios-backups/v2.0-20251201-120000/

[2/5] Creating module directories... ✓
  Created: core/, development/, product/, infrastructure/

[3/5] Moving files to modules... ✓
  Moved: 243 files
  Skipped: 0 files

[4/5] Updating import paths... ✓
  Updated: 87 file references

[5/5] Generating manifests... ✓
  Created: core/manifest.json
  Created: development/manifest.json
  Created: product/manifest.json
  Created: infrastructure/manifest.json

Migration complete!
Run 'aios migrate --validate' to verify.
```

### Step 4: Validate Migration

Verify the migration was successful:

```bash
aios migrate --validate
```

**Expected Output:**
```
Migration Validation Report
===========================

Module Structure:
  ✓ core/ exists with 45 files
  ✓ development/ exists with 156 files
  ✓ product/ exists with 69 files
  ✓ infrastructure/ exists with 63 files

File Integrity:
  ✓ All 243 files migrated
  ✓ No orphaned files
  ✓ No broken references

Module Manifests:
  ✓ core/manifest.json valid
  ✓ development/manifest.json valid
  ✓ product/manifest.json valid
  ✓ infrastructure/manifest.json valid

Import Validation:
  ✓ All imports resolve correctly
  ✓ No circular dependencies

VALIDATION PASSED
```

---

## File Mapping

### Agents

| v2.0 Location | v2.1 Location |
|---------------|---------------|
| `agents/dev.md` | `development/agents/dev.md` |
| `agents/qa.md` | `development/agents/qa.md` |
| `agents/architect.md` | `development/agents/architect.md` |
| `agents/po.md` | `development/agents/po.md` |
| `agents/pm.md` | `development/agents/pm.md` |
| `agents/sm.md` | `development/agents/sm.md` |
| `agents/analyst.md` | `development/agents/analyst.md` |
| `agents/devops.md` | `development/agents/devops.md` |
| `agents/data-engineer.md` | `development/agents/data-engineer.md` |
| `agents/ux-design-expert.md` | `development/agents/ux-design-expert.md` |
| `agents/aios-master.md` | `development/agents/aios-master.md` |

### Tasks

| v2.0 Location | v2.1 Location |
|---------------|---------------|
| `tasks/*.md` | `development/tasks/*.md` |

**Note:** Task files may be prefixed with agent ID (e.g., `dev-develop-story.md`).

### Templates

| v2.0 Location | v2.1 Location |
|---------------|---------------|
| `templates/*.yaml` | `product/templates/*.yaml` |
| `templates/*.md` | `product/templates/*.md` |
| `templates/ide-rules/*` | `product/templates/ide-rules/*` |

### Scripts

| v2.0 Location | v2.1 Location |
|---------------|---------------|
| `scripts/*.js` (infrastructure) | `infrastructure/scripts/*.js` |
| `scripts/*.js` (development) | `development/scripts/*.js` |
| `scripts/*.js` (core) | `core/*/*.js` |

### Configuration

| v2.0 Location | v2.1 Location |
|---------------|---------------|
| `config/config-loader.js` | `core/config/config-loader.js` |
| `config/config-cache.js` | `core/config/config-cache.js` |
| `elicitation/*.js` | `core/elicitation/*.js` |

---

## Troubleshooting

### Common Issues

#### Migration fails with "Permission denied"

```bash
# On Unix/macOS
sudo chown -R $USER .aios-core/

# On Windows (run as Administrator)
icacls .aios-core /grant:r "%USERNAME%:(OI)(CI)F"
```

#### "File not found" during validation

```bash
# Check if file exists in backup
ls .aios-backups/v2.0-*/agents/

# Manually copy missing file
cp .aios-backups/v2.0-*/agents/dev.md .aios-core/development/agents/
```

#### Import errors after migration

```bash
# Regenerate import mappings
aios migrate --fix-imports

# Or manually update imports
find .aios-core -name "*.js" -exec sed -i 's|../scripts/|../../infrastructure/scripts/|g' {} \;
```

#### Broken agent references

```bash
# Rebuild service registry
node .aios-core/core/registry/build-registry.js

# Validate agent dependencies
node --test tests/installer/v21-path-validation.test.js
```

### Validation Failures

| Error | Solution |
|-------|----------|
| `Module directory missing` | Run `mkdir -p .aios-core/{core,development,product,infrastructure}` |
| `Orphaned files detected` | Move files to appropriate module or delete if unused |
| `Circular dependency` | Review and refactor imports |
| `Manifest invalid` | Regenerate with `aios manifest generate` |

---

## Rollback

If migration fails or causes issues, rollback to v2.0:

### Automatic Rollback

```bash
aios migrate --rollback
```

**This will:**
1. Restore files from `.aios-backups/v2.0-*/`
2. Remove v2.1 module directories
3. Restore original import paths

### Manual Rollback

```bash
# Remove v2.1 structure
rm -rf .aios-core/core .aios-core/development .aios-core/product .aios-core/infrastructure

# Restore from backup
cp -r .aios-backups/v2.0-YYYYMMDD-HHMMSS/* .aios-core/

# Verify restore
ls .aios-core/
# Should show: agents/ tasks/ templates/ scripts/ ...
```

---

## Before/After Examples

### Directory Structure

**Before (v2.0):**
```
.aios-core/
├── agents/
│   ├── dev.md
│   ├── qa.md
│   └── ...
├── tasks/
│   ├── create-story.md
│   └── ...
├── templates/
│   ├── story-tmpl.yaml
│   └── ...
├── scripts/
│   ├── backup-manager.js
│   └── ...
├── config/
├── elicitation/
└── data/
```

**After (v2.1):**
```
.aios-core/
├── core/
│   ├── config/
│   ├── elicitation/
│   ├── registry/
│   ├── quality-gates/
│   ├── mcp/
│   └── utils/
├── development/
│   ├── agents/
│   ├── tasks/
│   ├── workflows/
│   └── scripts/
├── product/
│   ├── templates/
│   ├── checklists/
│   └── data/
└── infrastructure/
    ├── scripts/
    ├── tools/
    └── integrations/
```

### Import Paths

**Before (v2.0):**
```javascript
const backupManager = require('../scripts/backup-manager');
const configLoader = require('../config/config-loader');
```

**After (v2.1):**
```javascript
const backupManager = require('../../infrastructure/scripts/backup-manager');
const { loadAgentConfig } = require('../../core');
```

---

## Post-Migration Steps

1. **Rebuild Service Registry**
   ```bash
   node .aios-core/core/registry/build-registry.js
   ```

2. **Run Tests**
   ```bash
   npm test
   ```

3. **Verify Agent Loading**
   ```bash
   # Test agent activation
   aios agent activate dev
   ```

4. **Update IDE Configuration** (if needed)
   ```bash
   # Regenerate IDE rules
   aios config generate-ide-rules
   ```

5. **Commit Changes**
   ```bash
   git add .aios-core/
   git commit -m "chore: migrate AIOS to v2.1 modular architecture"
   ```

---

## Related Documentation

- [Module System Architecture](../architecture/module-system.md)
- [Service Discovery Guide](../guides/service-discovery.md)
- [ADR-002: Modular Architecture](../architecture/decisions/ADR-002-migration-map.md)
- [Story 2.14: Migration Script](../stories/v2.1/sprint-2/story-2.14-migration-script.md)

---

*AIOS-FULLSTACK v2.1 Migration Guide*
